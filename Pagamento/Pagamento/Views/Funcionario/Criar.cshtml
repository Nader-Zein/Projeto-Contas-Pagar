@model Pagamento.Models.Funcionario

@{
    ViewData["Title"] = "Cadastrar Funcionário";
}

<h2>@ViewData["Title"]</h2>

<form asp-action="Criar" method="post">
    <div class="row">
        <div class="d-flex justify-content-end mt-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" asp-for="Status" />
                <label class="form-check-label" asp-for="Status">Ativo</label>
            </div>
        </div>


        <div class="col-md-6 mb-3">
            <label class="form-label">Tipo de Pessoa</label>
            <input type="text" class="form-control" value="Física" disabled />
            <input type="hidden" name="TipoPessoa" value="Física" />
        </div>

        <div class="col-md-6 mb-3">
            <label asp-for="Nome_RazaoSocial" class="form-label">Nome </label>
            <input asp-for="Nome_RazaoSocial" class="form-control" />
            <span asp-validation-for="Nome_RazaoSocial" class="text-danger"></span>

        </div>

        <div class="col-md-6 mb-3">
            <label asp-for="Genero" class="form-label">Gênero</label>
            <select asp-for="Genero" class="form-control">
                <option value="">Selecione</option>
                <option value="Masculino">Masculino</option>
                <option value="Feminino">Feminino</option>
                <option value="Outro">Outro</option>
            </select>
            <span asp-validation-for="Genero" class="text-danger"></span>
        </div>


        <div class="col-md-6 mb-3">
            <label asp-for="Matricula" class="form-label">Matrícula</label>
            <input asp-for="Matricula" class="form-control" />
            <span asp-validation-for="Matricula" class="text-danger"></span>
        </div>

        <div class="col-md-6 mb-3">
            <label asp-for="Endereco" class="form-label">Endereço</label>
            <input asp-for="Endereco" class="form-control" />
            <span asp-validation-for="Endereco" class="text-danger"></span>

        </div>

        <div class="col-md-6 mb-3">
            <label asp-for="Numero" class="form-label">Número</label>
            <input asp-for="Numero" class="form-control" />
            <span asp-validation-for="Numero" class="text-danger"></span>
        </div>

        <div class="col-md-6 mb-3">
            <label asp-for="Complemento" class="form-label">Complemento</label>
            <input asp-for="Complemento" class="form-control" />
        </div>

        <div class="col-md-6 mb-3">
            <label asp-for="Bairro" class="form-label">Bairro</label>
            <input asp-for="Bairro" class="form-control" />
            <span asp-validation-for="Bairro" class="text-danger"></span>

        </div>

        <div class="col-md-6 mb-3">
            <label asp-for="Cep" class="form-label">CEP</label>
            <input asp-for="Cep" class="form-control" />
            <span asp-validation-for="Cep" class="text-danger"></span>
        </div>

        <div class="col-md-6 mb-3">
            <label class="form-label">Cidade</label>
            <div class="input-group">
                <input type="text" id="NomeCidadeSelecionada" class="form-control" placeholder="Nenhuma cidade selecionada" readonly />
                <input type="hidden" asp-for="IdCidade" id="IdCidade" value="0" />
                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalCidade">
                    Selecionar Cidade
                </button>
            </div>
            <span asp-validation-for="IdCidade" class="text-danger"></span>

        </div>

        <div class="col-md-6 mb-3">
            <label asp-for="DataNascimento_Fundacao" class="form-label">Data de Nascimento</label>
            <input asp-for="DataNascimento_Fundacao" type="date" class="form-control" />
            <span asp-validation-for="DataNascimento_Fundacao" class="text-danger"></span>

        </div>

        <div class="col-md-6 mb-3">
            <label asp-for="CPF_CNPJ" class="form-label">CPF</label>
            <input asp-for="CPF_CNPJ" class="form-control" />
            <span asp-validation-for="CPF_CNPJ" class="text-danger"></span>
        </div>

        <div class="col-md-6 mb-3">
            <label asp-for="RG_InsEstadual" class="form-label">RG</label>
            <input asp-for="RG_InsEstadual" class="form-control" />
            <span asp-validation-for="RG_InsEstadual" class="text-danger"></span>
        </div>

        <div class="col-md-6 mb-3">
            <label asp-for="Email" class="form-label">Email</label>
            <input asp-for="Email" class="form-control" />
            <span asp-validation-for="Email" class="text-danger"></span>
        </div>

        <div class="col-md-6 mb-3">
            <label asp-for="Telefone" class="form-label">Telefone</label>
            <input asp-for="Telefone" class="form-control" />
            <span asp-validation-for="Telefone" class="text-danger"></span>

        </div>

        <div class="col-md-6 mb-3">
            <label asp-for="Cargo" class="form-label">Cargo</label>
            <input asp-for="Cargo" class="form-control" />
            <span asp-validation-for="Cargo" class="text-danger"></span>
        </div>

        <div class="col-md-6 mb-3">
            <label asp-for="Salario" class="form-label">Salário</label>
            <input asp-for="Salario" class="form-control" type="number" step="0.01" />
            <span asp-validation-for="Salario" class="text-danger"></span>
        </div>

        <div class="col-md-6 mb-3">
            <label asp-for="Turno" class="form-label">Turno</label>
            <select asp-for="Turno" class="form-control">
                <option value="">Selecione</option>
                <option value="Manhã">Manhã</option>
                <option value="Tarde">Tarde</option>
                <option value="Noite">Noite</option>
                <option value="Integral">Integral</option>
            </select>
            <span asp-validation-for="Turno" class="text-danger"></span>
        </div>

        <div class="col-md-6 mb-3">
            <label asp-for="CargaHoraria" class="form-label">Carga Horária (h/semana)</label>
            <input asp-for="CargaHoraria" class="form-control" type="number" />
            <span asp-validation-for="CargaHoraria" class="text-danger"></span>
        </div>

        <div class="col-md-6 mb-3">
            <label asp-for="DataAdmissao" class="form-label">Data de Admissão</label>
            <input asp-for="DataAdmissao" class="form-control" type="date" />
            <span asp-validation-for="DataAdmissao" class="text-danger"></span>
        </div>

        <div class="col-md-6 mb-3">
            <label asp-for="DataDemissao" class="form-label">Data de Demissão</label>
            <input asp-for="DataDemissao" class="form-control" type="date" />
        </div>

        @if (Model != null)
        {
            <div class="col-md-6 mb-3">
                <label class="form-label">Data de Criação</label>
                <input type="text" class="form-control" value="@Model.DataCriacao.ToString("dd/MM/yyyy HH:mm")" readonly />
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Última Edição</label>
                <input type="text" class="form-control" value="@(Model.DataEdicao?.ToString("dd/MM/yyyy HH:mm") ?? "Nunca editado")" readonly />
            </div>
        }
    </div>

    <div class="text-end mt-3">
        <button type="submit" class="btn btn-success">Salvar</button>
        <a asp-action="Index" class="btn btn-secondary">Cancelar</a>
    </div>
</form>

<div class="modal fade" id="modalCidade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Selecionar Cidade</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="filtroCidade" class="form-control mb-3" placeholder="Filtrar por nome..." onkeyup="filtrarTabelaCidade()" />
                <table class="table table-bordered" id="tabelaCidades">
                    <thead>
                        <tr><th>Nome</th><th>Ação</th></tr>
                    </thead>
                    <tbody>
                        @foreach (var cidade in ViewBag.Cidades as List<SelectListItem>)
                        {
                            <tr>
                                <td>@cidade.Text</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="selecionarCidade(@cidade.Value, '@cidade.Text')">Selecionar</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                <hr />
                <button class="btn btn-success" onclick="abrirFormNovaCidade()">+ Cadastrar nova Cidade</button>
                <div id="formNovaCidadeContainer"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNovaCidade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" id="modalNovaCidadeContent">
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        function selecionarCidade(id, nome) {
            document.getElementById("IdCidade").value = id;
            document.getElementById("NomeCidadeSelecionada").value = nome;
            var modal = bootstrap.Modal.getInstance(document.getElementById("modalCidade"));
            modal.hide();
        }

        function abrirFormNovaCidade() {
            $.get('@Url.Action("FormModal", "Cidade")', function (html) {
                $('#modalNovaCidadeContent').html(html);
                var modal = new bootstrap.Modal(document.getElementById('modalNovaCidade'));
                modal.show();
            });
        }

        function filtrarTabelaCidade() {
            var filtro = document.getElementById("filtroCidade").value.toLowerCase();
            document.querySelectorAll("#tabelaCidades tbody tr").forEach(function (linha) {
                var nome = linha.cells[0].innerText.toLowerCase();
                linha.style.display = nome.includes(filtro) ? "" : "none";
            });
        }

        $(document).off('submit', '#formCadastrarCidade');
        $(document).on('submit', '#formCadastrarCidade', function (e) {
            e.preventDefault();
            const $form = $(this);
            const $submit = $form.find("button[type=submit]");
            $submit.prop("disabled", true);

            $.post('@Url.Action("FormModal", "Cidade")', $form.serialize(), function (res) {
                if (res.sucesso) {
                    $('#modalNovaCidade').modal('hide');
                    var novaLinha = `<tr><td>${res.cidade.nome}</td>
                        <td><button class='btn btn-sm btn-primary' onclick='selecionarCidade(${res.cidade.id}, "${res.cidade.nome}")'>Selecionar</button></td></tr>`;
                    $('#tabelaCidades tbody').append(novaLinha);
                } else {
                    $('#modalNovaCidadeContent').html(res);
                }
                $submit.prop("disabled", false);
            });
        });
    </script>
}
